#!/usr/bin/env ruby

require 'sqlite3'
require 'faraday'
require 'json'

set -e

bundle install

echo
echo '== Tudo configurado, pode iniciar ;) =='

puts '== Instalando dependÃªncias =='
system 'gem install bundler --conservative'
system('bundle check') || system('bundle install')

puts "\n== Preparando banco de dados =="

DB_FILE = 'ibge_nomes.db'
begin
  db = SQLite3::Database.open DB_FILE
  db.execute <<~SQL
    CREATE TABLE Estados(
      id integer PRIMARY KEY  ,
      sigla varchar(10) NOT NULL,
      nome varchar(100) NOT NULL
    );
  SQL

  response = Faraday.get('https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome')
  json = JSON.parse(response.body, symbolize_names: true)
  estados = []
  json.map do |dados|
    @id = dados[:id]
    @sigla = dados[:sigla]
    @nome = dados[:nome]
    estados << [@id, @sigla, @nome]
  end
    estados.each do |estado|
     db.execute "INSERT INTO Estados VALUES(?,?,?)", estado
    end
rescue SQLite3::Exception => e
  puts e
ensure
  db.close if db
end
begin
  db = SQLite3::Database.open DB_FILE
  db.execute <<~SQL
    CREATE TABLE Cidades(
    id integer PRIMARY KEY ,
    sigla varchar(10) NOT NULL,
    nome varchar(100) NOT NULL
    );
  SQL

  response = Faraday.get('https://servicodados.ibge.gov.br/api/v1/localidades/municipios?orderBy=nome')
  json = JSON.parse(response.body, symbolize_names: true)
  cidades = []
  json.map do |dados|
    @id = dados[:id]
    @sigla = dados[:sigla]
    @nome = dados[:nome]
    cidades << [@id, @sigla, @nome]
    end
    cidades.each do |cidade|
      db.execute "INSERT INTO Cidades VALUES(?,?,?)", cidade
    end
rescue SQLite3::Exception => e
  puts e
ensure
  db.close if db
end
